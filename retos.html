<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Econnect - Retos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES (INTACTOS) --- */
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background: linear-gradient(rgba(34, 85, 45, 0.5), rgba(10, 40, 20, 0.75)), url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=2074&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; color: white; min-height: 100vh; display: flex; justify-content: center; }
        
        /* TEMA OSCURO (Tu c√≥digo corregido) */
        body.dark-theme { background: linear-gradient(rgba(10, 30, 15, 0.8), rgba(10, 30, 15, 0.9)), url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=2074&auto=format&fit=crop') !important; background-size: cover !important; background-position: center !important; background-attachment: fixed !important; }
        body.dark-theme .glass-card, body.dark-theme .challenge-card, body.dark-theme .mini-challenge, body.dark-theme .tabs-header, body.dark-theme .nav-item, body.dark-theme .modal-content, body.dark-theme .ranking-list, body.dark-theme .podium-block { background: rgba(0, 0, 0, 0.4) !important; border: 1px solid rgba(255,255,255,0.05) !important; }
        body.dark-theme .bottom-nav { background: rgba(20, 20, 20, 0.95) !important; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        body.dark-theme .modal-box, body.dark-theme .app-container.modal-view { background: #181818 !important; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        body.dark-theme h1, body.dark-theme h2, body.dark-theme strong, body.dark-theme .item-text { color: #ffffff !important; }
        body.dark-theme p, body.dark-theme .section-label, body.dark-theme .desc { color: #bbbbbb !important; }
        /* Correcci√≥n botones men√∫ */
        body.dark-theme .nav-item { background: transparent !important; border: none !important; box-shadow: none !important; }

        .app-container { width: 100%; max-width: 500px; padding: 20px; padding-bottom: 110px; box-sizing: border-box; display: flex; flex-direction: column; position: relative; }
        .tabs-header { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; background: rgba(255, 255, 255, 0.15); padding: 5px; border-radius: 50px; backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: rgba(255, 255, 255, 0.8); font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 13px; border-radius: 40px; cursor: pointer; transition: all 0.3s; }
        .tab-btn.active { background: #4ade80; color: #064e3b; box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4); }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-card { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 35px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .challenge-card { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); border-radius: 30px; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 20px; }
        .challenge-header-img { width: 100%; height: 160px; object-fit: cover; mask-image: linear-gradient(to bottom, black 70%, transparent 100%); }
        .content-wrapper { padding: 20px; text-align: center; }
        .tag { display: inline-block; background: #4ade80; color: #064e3b; padding: 4px 12px; border-radius: 15px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
        h1 { font-size: 22px; font-weight: 700; margin: 0 0 10px 0; }
        .desc { font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 20px; line-height: 1.4; }
        .action-btn { width: 100%; background: #4ade80; color: #064e3b; border: none; padding: 14px; border-radius: 50px; font-weight: 700; font-size: 15px; cursor: pointer; font-family: 'Poppins', sans-serif; transition: transform 0.2s; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(74, 222, 128, 0.4); }
        .steps-list { text-align: left; margin-bottom: 20px; }
        .step-item { display: flex; align-items: center; margin-bottom: 12px; color: rgba(255,255,255,0.9); font-size: 13px; }
        .step-icon { width: 25px; font-size: 18px; color: #4ade80; margin-right: 10px; text-align: center; }
        .step-icon.pending { color: rgba(255,255,255,0.3); }
        
        .more-challenges-title { font-size: 16px; font-weight: 700; margin: 10px 0 15px 0; text-align: left; padding-left: 10px; }
        .mini-challenge { display: flex; align-items: center; background: rgba(255,255,255,0.08); padding: 12px; border-radius: 20px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s; }
        .mini-challenge:hover { background: rgba(255,255,255,0.15); }
        .mini-icon { width: 40px; height: 40px; background: rgba(74, 222, 128, 0.2); border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #4ade80; font-size: 18px; margin-right: 15px; }
        .mini-info { text-align: left; flex-grow: 1; }
        .mini-title { font-size: 14px; font-weight: 600; display: block; }
        .mini-points { font-size: 11px; color: #4ade80; font-weight: 700; }
        .mini-arrow { color: rgba(255,255,255,0.5); }
        .mini-challenge.completed { background: rgba(74, 222, 128, 0.15); border-color: #4ade80; }
        .mini-challenge.completed .mini-icon { background: #4ade80; color: #064e3b; }
        .mini-challenge.completed .mini-arrow { color: #4ade80; content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; }
        
        .reto-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .reto-modal-overlay.show { display: flex; animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-content { width: 100%; max-width: 450px; background: #1a1a1a; border-radius: 30px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .close-modal-btn { position: absolute; top: 15px; right: 15px; width: 35px; height: 35px; background: rgba(0,0,0,0.5); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10; }
        
        .big-fire-icon { font-size: 100px; background: linear-gradient(to bottom, #fff176 0%, #ff9800 50%, #ff3d00 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px rgba(255, 87, 34, 0.6)); margin-bottom: 10px; animation: breatheFire 2.5s infinite ease-in-out; display: inline-block; }
        @keyframes breatheFire { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
        .big-fire-icon.inactive { background: linear-gradient(to bottom, #cfcfcf 0%, #888888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1)); animation: none; }
        .racha-number { font-size: 52px; font-weight: 800; line-height: 1; color: #fff; margin-bottom: 5px; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .racha-label { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 3px; color: rgba(255, 255, 255, 0.7); }
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        .month-title { font-weight: 700; font-size: 16px; color: white; }
        .arrow-btn { cursor: pointer; padding: 8px; color: rgba(255,255,255,0.8); transition: 0.2s; font-size: 18px; }
        .arrow-btn.hidden { opacity: 0; pointer-events: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .day-label { font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 8px; }
        .day-cell { height: 34px; display: flex; justify-content: center; align-items: center; font-size: 13px; font-weight: 600; border-radius: 10px; color: white; position: relative; }
        .day-cell.completed { background: linear-gradient(135deg, #ff9800, #f57c00); box-shadow: 0 4px 10px rgba(245, 124, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.2); }
        .day-cell.today { border: 2px solid #fff; background: rgba(255, 255, 255, 0.1); }
        .day-cell.future { color: rgba(255,255,255,0.3); }
        
        .share-btn { width: 100%; background: linear-gradient(90deg, #4ade80, #064e3b); color: white; border: none; padding: 16px; border-radius: 50px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 10px 30px rgba(74, 222, 128, 0.4); margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; font-family: 'Poppins', sans-serif; transition: transform 0.2s; }
        .share-btn:hover { transform: translateY(-3px); }
        
        .ranking-toggle { display: flex; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 4px; margin-bottom: 20px; }
        .rank-switch { flex: 1; padding: 8px; border: none; background: transparent; color: rgba(255,255,255,0.6); font-weight: 600; font-size: 12px; border-radius: 12px; cursor: pointer; }
        .rank-switch.active { background: rgba(255,255,255,0.1); color: white; }
        .podium-container { display: flex; justify-content: center; align-items: flex-end; height: 180px; margin-bottom: 20px; gap: 10px; }
        .podium-item { display: flex; flex-direction: column; align-items: center; width: 30%; }
        .podium-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.2); margin-bottom: -10px; z-index: 2; }
        .podium-name { font-size: 10px; font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
        .podium-block { width: 100%; border-top-left-radius: 15px; border-top-right-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: 700; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); }
        .score-pill { margin-top: 5px; font-size: 9px; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; }
        .first .podium-block { height: 100px; background: linear-gradient(to bottom, rgba(253, 216, 53, 0.6), rgba(253, 216, 53, 0.2)); border-top: 2px solid #fdd835; }
        .second .podium-block { height: 70px; background: linear-gradient(to bottom, rgba(224, 224, 224, 0.6), rgba(224, 224, 224, 0.2)); border-top: 2px solid #e0e0e0; }
        .third .podium-block { height: 50px; background: linear-gradient(to bottom, rgba(161, 136, 127, 0.6), rgba(161, 136, 127, 0.2)); border-top: 2px solid #a1887f; }
        .ranking-list { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 5px; backdrop-filter: blur(10px); }
        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .points-badge { background: rgba(74, 222, 128, 0.1); color: #4ade80; padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
        
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); text-decoration: none; cursor: pointer; font-size: 10px; transition: all 0.3s; position: relative; }
        .nav-item:hover i { transform: translateY(-3px); color: white; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: transform 0.3s; }
        .nav-item.active { color: #4ade80; font-weight: 600; }
        .nav-item.active i { transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -8px; width: 5px; height: 5px; background-color: #4ade80; border-radius: 50%; box-shadow: 0 0 10px #4ade80; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab('diario')">Reto Diario</button>
        <button class="tab-btn" onclick="openTab('racha')">Mi Racha</button>
        <button class="tab-btn" onclick="openTab('ranking')">Ranking</button>
    </div>

    <div id="tab-diario" class="tab-content active">
        
        <div id="active-challenge-container">
            <div class="challenge-card">
                <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?q=80&w=2013&auto=format&fit=crop" class="challenge-header-img" id="main-chal-img">
                <div class="content-wrapper">
                    <div><span class="tag" id="main-chal-type">Reto Diario</span></div>
                    <h1 id="main-chal-title">Planta un √Årbol</h1>
                    <p class="desc" id="main-chal-desc">Busca un lugar en tu comunidad y siembra una semilla para el futuro.</p>
                    <div class="steps-list" id="main-chal-steps">
                        <div class="step-item"><i class="fa-solid fa-leaf step-icon"></i><span>Siembra tu semilla</span></div>
                        <div class="step-item"><i class="fa-solid fa-camera step-icon pending" id="main-icon-camera"></i><span>Sube foto</span></div>
                    </div>
                    <button class="action-btn" id="btn-main-action" onclick="abrirCamara('main')">Completar (+100 pts)</button>
                </div>
            </div>
        </div>

        <div class="more-challenges-title">M√°s Retos</div>

        <div id="other-challenges-list">
            </div>

        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="fotoSubida()">
    </div>

    <div id="tab-racha" class="tab-content">
        <div class="glass-card">
            <i class="fa-solid fa-fire big-fire-icon" id="fire-icon"></i>
            <div class="racha-number" id="streak-number">150</div>
            <div class="racha-label" id="streak-label">D√çAS EN RACHA</div>
        </div>
        <div class="glass-card">
            <div class="calendar-header">
                <div class="month-title" id="month-label">Octubre 2025</div>
                <div class="nav-controls">
                    <i class="fa-solid fa-chevron-left arrow-btn hidden" id="prev-btn"></i>
                    <i class="fa-solid fa-chevron-right arrow-btn" id="next-btn" onclick="cambiarMes(1)"></i>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        <button class="share-btn" onclick="alert('¬°Compartiendo tu logro! üöÄ')">
            <i class="fa-solid fa-share-nodes"></i> Compartir Logro
        </button>
    </div>

    <div id="tab-ranking" class="tab-content">
        <div class="ranking-toggle">
            <button class="rank-switch active" onclick="toggleRanking('amigos', this)">Amigos</button>
            <button class="rank-switch" onclick="toggleRanking('global', this)">Global</button>
        </div>

        <div id="ranking-amigos">
            <div class="podium-container">
                <div class="podium-item second">
                    <span class="podium-name">Los L√≥pez</span>
                    <img src="lopez_perfil.jpg" onerror="this.src='https://i.pravatar.cc/150?u=sara'" class="podium-avatar">
                    <div class="podium-block">2<div class="score-pill">227 üî•</div></div>
                </div>
                <div class="podium-item first">
                    <span class="podium-name">Pedro Garc√≠a</span>
                    <img src="pedro_perfil.jpg" class="podium-avatar">
                    <div class="podium-block">1<div class="score-pill">304 üî•</div></div>
                </div>
                <div class="podium-item third">
                    <span class="podium-name">Guille Arenas</span>
                    <img src="guille_perfil.jpg" onerror="this.src='https://i.pravatar.cc/150?u=ada'" class="podium-avatar">
                    <div class="podium-block">3<div class="score-pill">199 üî•</div></div>
                </div>
            </div>
            <div class="ranking-list">
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">4</span><span>Marta Nortes</span></div><span class="points-badge">187 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">5</span><span>Sara Ruiz</span></div><span class="points-badge">168 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">6</span><span>Ada Gracia</span></div><span class="points-badge">142 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">7</span><span>Mar√≠a Dolores</span></div><span class="points-badge">112 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">8</span><span>Alejandro Rodrigo</span></div><span class="points-badge">72 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">9</span><span>Melany Acosta</span></div><span class="points-badge">63 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">10</span><span>Daniela Gonz√°lez</span></div><span class="points-badge">42 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">11</span><span>Protectora Gatuna</span></div><span class="points-badge">38 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">12</span><span>Max Serrano</span></div><span class="points-badge">32 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">13</span><span>Mar Sampere</span></div><span class="points-badge">16 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">14</span><span>Tara le√≥n</span></div><span class="points-badge">6 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">15</span><span>Isaac Delgado</span></div><span class="points-badge">2 üî•</span></div>
                </div>
        </div>

        <div id="ranking-global" style="display:none;">
            <div class="podium-container">
                <div class="podium-item second">
                    <span class="podium-name">@GreenHero</span>
                    <img src="https://picsum.photos/seed/hero/100" class="podium-avatar">
                    <div class="podium-block">2<div class="score-pill">850 üî•</div></div>
                </div>
                <div class="podium-item first">
                    <span class="podium-name">@EcoMaster</span>
                    <img src="https://picsum.photos/seed/master/100" class="podium-avatar">
                    <div class="podium-block">1<div class="score-pill">920 üî•</div></div>
                </div>
                <div class="podium-item third">
                    <span class="podium-name">@NatureBoy</span>
                    <img src="https://picsum.photos/seed/nature/100" class="podium-avatar">
                    <div class="podium-block">3<div class="score-pill">780 üî•</div></div>
                </div>
            </div>
            <div class="ranking-list">
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">4</span><span>@forestGal</span></div><span class="points-badge">650 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">5</span><span>@recycleKing</span></div><span class="points-badge">620 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">6</span><span>@ecoMaster_23</span></div><span class="points-badge">599 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">7</span><span>@green_ninja</span></div><span class="points-badge">597 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">8</span><span>@planetSaver88</span></div><span class="points-badge">578 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">9</span><span>@gaiaWalker</span></div><span class="points-badge">566 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">10</span><span>@zerowaste_Kim</span></div><span class="points-badge">523 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">11</span><span>@solar_Ray</span></div><span class="points-badge">504 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">12</span><span>@bio_logic</span></div><span class="points-badge">492 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">13</span><span>@theHugger_pro</span></div><span class="points-badge">490 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">14</span><span>@cleanSeas_Dan</span></div><span class="points-badge">481 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">15</span><span>@urbanGardener</span></div><span class="points-badge">465 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">16</span><span>@Recycle_Queen</span></div><span class="points-badge">437 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">17</span><span>@Nature_nomad</span></div><span class="points-badge">436 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">18</span><span>@carbonFreeLife</span></div><span class="points-badge">422 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">19</span><span>@theLorax_real</span></div><span class="points-badge">398 üî•</span></div>
                <div class="rank-item"><div style="display:flex; gap:15px; align-items:center;"><span class="rank-pos">20</span><span>@pauuu.mvr</span></div><span class="points-badge">385 üî•</span></div>
                 <div class="rank-item" style="background: rgba(74, 222, 128, 0.15); border: 1px solid #4ade80;">
                    <div style="display:flex; gap:15px; align-items:center;">
                        <span class="rank-pos" style="color:white">342</span>
                        <span>T√∫</span>
                    </div>
                    <span class="points-badge">150 üî•</span>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="location.href='mapa.html'"><i class="fa-solid fa-map-location-dot"></i><span>Mapa</span></div>
        <div class="nav-item active" onclick="location.href='retos.html'"><i class="fa-solid fa-trophy"></i><span>Retos</span></div>
        <div class="nav-item" onclick="location.href='home.html'"><i class="fa-solid fa-users-line"></i><span>Social</span></div>
        <div class="nav-item" onclick="location.href='amigos.html'"><i class="fa-solid fa-user-group"></i><span>Amigos</span></div>
        <div class="nav-item" onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i><span>Perfil</span></div>
    </nav>

</div>

<div id="reto-modal" class="reto-modal-overlay">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="cerrarMiniReto()"><i class="fa-solid fa-xmark"></i></div>
        <img id="modal-img" class="challenge-header-img" src="">
        <div class="content-wrapper">
            <span class="tag" id="modal-type">Reto Extra</span>
            <h1 id="modal-title">T√≠tulo</h1>
            <p class="desc" id="modal-desc">Descripci√≥n</p>
            <div class="steps-list" id="modal-steps"></div>
            <button class="action-btn" id="modal-action-btn" onclick="abrirCamara('modal')">Completar</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyDeIyDCNlBnBIDpcvLfsjiqjEX7Kk8561g", authDomain: "ecconect-ae607.firebaseapp.com", projectId: "ecconect-ae607", storageBucket: "ecconect-ae607.firebasestorage.app", messagingSenderId: "241708782882", appId: "1:241708782882:web:514d895119f9f7c3fa817b", measurementId: "G-KJ3FLCHZCG" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "index.html"; });

    // --- 1. BASE DE DATOS UNIFICADA (Retos est√°ticos + los del mapa) ---
    // Importante: IDs num√©ricos coinciden con mapa.html para enlazar
    const allChallengesDB = [
        // RETOS DEL MAPA
        { id: 1, type: 'map', titulo: "Ruta Campus UA", categoria: "Bicicleta", puntos: 60, img: "https://web.ua.es/es/bici.jpg", desc: "Cicloruta para conocer los alrededores de la Universidad de Alicante.", icon: "fa-person-biking" },
        { id: 2, type: 'map', titulo: "Limpieza Parque", categoria: "Voluntariado", puntos: 80, img: "https://previews.123rf.com/images/dolgachov/dolgachov1709/dolgachov170900115/85023679-volunteers-with-garbage-bags-cleaning-park-area.jpg", desc: "Recogida de pl√°sticos expr√©s en el parque.", icon: "fa-trash-can" },
        { id: 3, type: 'map', titulo: "Ecopunto", categoria: "Reciclaje", puntos: 40, img: "https://www.alicantelimpia.com/img/servicios/ecopunto.jpg", desc: "Lleva tus pilas usadas al ecopunto m√°s cercano.", icon: "fa-recycle" },
        { id: 4, type: 'map', titulo: "Caminata Verde", categoria: "Senderismo", puntos: 70, img: "https://www.alltrails.com/mugen/image/location-app-router?url=https%3A%2F%2Fimages.alltrails.com%2FeyJidWNrZXQiOiJhc3NldHMuYWxsdHJhaWxzLmNvbSIsImtleSI6InVwbG9hZHMvcGhvdG8vaW1hZ2UvNjc3MTM1ODcvOWM2ZjRhMjZjNWRmYzg5OTA4ZGQzNmIzYThhYTdkMTEuanBnIiwiZWRpdHMiOnsidG9Gb3JtYXQiOiJ3ZWJwIiwicmVzaXplIjp7IndpZHRoIjoxMDgwLCJoZWlnaHQiOjcwMCwiZml0IjoiY292ZXIifSwicm90YXRlIjpudWxsLCJqcGVnIjp7InRyZWxsaXNRdWFudGlzYXRpb24iOnRydWUsIm92ZXJzaG9vdERlcmluZ2luZyI6dHJ1ZSwib3B0aW1pc2VTY2FucyI6dHJ1ZSwicXVhbnRpc2F0aW9uVGFibGUiOjN9fX0%3D&w=3840&q=90", desc: "Paseo saludable por la zona norte.", icon: "fa-person-hiking" },
        { id: 5, type: 'map', titulo: "Busca 3 fuentes", categoria: "Busqueda", puntos: 30, img: "https://media.istockphoto.com/id/1490514521/es/foto/fuente-de-agua-en-el-parque.jpg?s=612x612&w=0&k=20&c=BQRXQzsmEnti1CNCUPN2BY5ClgBtxhCdtD6PU7hXB3A=", desc: "Encuentra tres fuentes de agua potable.", icon: "fa-faucet-drip" },
        
        // RETOS EXTRA (Originales de retos.html) - Les doy IDs altos para no chocar
        { id: 101, type: 'static', titulo: "Transporte Verde", categoria: "Transporte", puntos: 50, img: "https://images.unsplash.com/photo-1485965120184-e224f7a1adb1?q=80&w=2070&auto=format&fit=crop", desc: "Usa la bici o transporte p√∫blico hoy.", icon: "fa-bicycle" },
        { id: 102, type: 'static', titulo: "Reciclaje Perfecto", categoria: "Reciclaje", puntos: 30, img: "https://images.unsplash.com/photo-1532996122724-e3c354a0b15b?q=80&w=2070&auto=format&fit=crop", desc: "Separa correctamente 5 residuos.", icon: "fa-trash-arrow-up" },
        { id: 103, type: 'static', titulo: "Ahorro de Energ√≠a", categoria: "Energ√≠a", puntos: 20, img: "https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?q=80&w=2070&auto=format&fit=crop", desc: "Mant√©n luces apagadas durante el d√≠a.", icon: "fa-lightbulb" },
        { id: 104, type: 'static', titulo: "D√≠a Sin Carne", categoria: "Alimentaci√≥n", puntos: 40, img: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=2070&auto=format&fit=crop", desc: "Come 100% vegetariano hoy.", icon: "fa-carrot" },
        { id: 105, type: 'static', titulo: "Compra Sostenible", categoria: "Consumo", puntos: 35, img: "https://images.unsplash.com/photo-1550989460-0adf9ea622e2?q=80&w=1887&auto=format&fit=crop", desc: "Usa bolsas de tela reutilizables.", icon: "fa-bag-shopping" },
        { id: 106, type: 'static', titulo: "Ducha Express", categoria: "Agua", puntos: 25, img: "https://images.unsplash.com/photo-1515238152791-8216bfdf89a7?q=80&w=2072&auto=format&fit=crop", desc: "D√∫chate en menos de 5 minutos.", icon: "fa-shower" }
    ];

    // Reto "Diario" por defecto (si no vienes del mapa)
    const dailyChallenge = {
        id: 0,
        titulo: "Planta un √Årbol",
        categoria: "Reto Diario",
        puntos: 100,
        img: "https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?q=80&w=2013&auto=format&fit=crop",
        desc: "Busca un lugar en tu comunidad y siembra una semilla para el futuro.",
        steps: ['Siembra tu semilla', 'Riega con amor', 'Sube foto']
    };

    let activeChallenge = dailyChallenge; // Por defecto
    let retoActualID = null; // Para el modal
    const completedChallenges = new Set(); // Guardar IDs completados en memoria

    // --- CARGAR L√ìGICA DE INICIO ---
    function initChallenges() {
        const urlParams = new URLSearchParams(window.location.search);
        const mapRetoId = urlParams.get('reto_id');

        // 1. Determinar cu√°l es el Reto Activo (Grande)
        if (mapRetoId) {
            const found = allChallengesDB.find(c => c.id == mapRetoId);
            if (found) {
                activeChallenge = found;
            }
        }

        // 2. Renderizar Reto Activo
        renderActiveChallenge(activeChallenge);

        // 3. Renderizar Lista "M√°s Retos" (Todos menos el activo)
        const listContainer = document.getElementById('other-challenges-list');
        listContainer.innerHTML = ''; // Limpiar

        allChallengesDB.forEach(chal => {
            if (chal.id !== activeChallenge.id) {
                const html = `
                    <div class="mini-challenge" id="card-${chal.id}" onclick="abrirMiniReto(${chal.id})">
                        <div class="mini-icon"><i class="fa-solid ${chal.icon}"></i></div>
                        <div class="mini-info">
                            <span class="mini-title">${chal.titulo}</span>
                            <span class="mini-points">+${chal.puntos} pts</span>
                        </div>
                        <i class="fa-solid fa-chevron-right mini-arrow" id="icon-${chal.id}"></i>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            }
        });
    }

    function renderActiveChallenge(chal) {
        document.getElementById('main-chal-title').innerText = chal.titulo;
        document.getElementById('main-chal-desc').innerText = chal.desc;
        document.getElementById('main-chal-img').src = chal.img;
        document.getElementById('main-chal-type').innerText = chal.categoria;
        
        // Pasos gen√©ricos si no tiene espec√≠ficos
        const stepsContainer = document.getElementById('main-chal-steps');
        if (chal.id === 0) {
            // Es el diario, dejamos los pasos hardcodeados o los reescribimos
            // Ya est√°n en HTML, no hace falta tocar
        } else {
            stepsContainer.innerHTML = `
                <div class="step-item"><i class="fa-solid fa-location-dot step-icon"></i><span>Ve a la ubicaci√≥n</span></div>
                <div class="step-item"><i class="fa-solid fa-play step-icon"></i><span>Realiza la actividad</span></div>
                <div class="step-item"><i class="fa-solid fa-camera step-icon pending" id="main-icon-camera"></i><span>Sube foto</span></div>
            `;
        }
    }

    // --- MODALES Y COMPLETAR ---
    window.abrirMiniReto = function(id) {
        retoActualID = id;
        const chal = allChallengesDB.find(c => c.id == id);
        
        document.getElementById('modal-title').innerText = chal.titulo;
        document.getElementById('modal-desc').innerText = chal.desc;
        document.getElementById('modal-img').src = chal.img;
        document.getElementById('modal-type').innerText = chal.categoria;
        
        // Pasos gen√©ricos visuales
        document.getElementById('modal-steps').innerHTML = `
            <div class="step-item"><i class="fa-solid fa-check step-icon"></i><span>Prep√°rate</span></div>
            <div class="step-item"><i class="fa-solid fa-check step-icon"></i><span>Hazlo</span></div>
            <div class="step-item"><i class="fa-solid fa-check step-icon"></i><span>Foto</span></div>
        `;

        const btn = document.getElementById('modal-action-btn');
        if (completedChallenges.has(id)) {
            btn.textContent = "¬°Ya completado!";
            btn.style.background = "white";
            btn.style.color = "#1b5e20";
            btn.disabled = true;
            btn.onclick = null;
        } else {
            btn.textContent = "Completar";
            btn.style.background = "#4ade80";
            btn.style.color = "#064e3b";
            btn.disabled = false;
            btn.onclick = function() { abrirCamara('modal'); };
        }
        document.getElementById('reto-modal').classList.add('show');
    }

    window.cerrarMiniReto = function() {
        document.getElementById('reto-modal').classList.remove('show');
    }

    let sourceBtn = null;
    window.abrirCamara = function(source) {
        sourceBtn = source; // 'main' o 'modal'
        document.getElementById('camera-input').click();
    }

    window.fotoSubida = function() {
        alert("¬°Foto recibida! +Puntos a√±adidos üì∏");
        
        if (sourceBtn === 'main') {
            // Completar el grande
            const btn = document.getElementById('btn-main-action');
            btn.textContent = "¬°Reto Completado!";
            btn.style.background = "white";
            btn.style.color = "#1b5e20";
            btn.onclick = null;
            const icon = document.getElementById('main-icon-camera');
            if(icon) { icon.classList.remove('pending'); icon.classList.add('fa-circle-check'); icon.style.color="#4ade80"; }
        } else {
            // Completar el mini
            completedChallenges.add(retoActualID);
            
            // Actualizar modal
            const btn = document.getElementById('modal-action-btn');
            btn.textContent = "¬°Completado!";
            
            // Actualizar lista
            const card = document.getElementById(`card-${retoActualID}`);
            const arrow = document.getElementById(`icon-${retoActualID}`);
            if (card) card.classList.add('completed');
            if (arrow) {
                arrow.classList.remove('fa-chevron-right');
                arrow.classList.add('fa-check');
            }
            setTimeout(cerrarMiniReto, 1000);
        }
    }

    // --- RACHA Y CALENDARIO ---
    const diasRacha = 150; 
    function initRacha() { /* ... tu c√≥digo de racha ... */ if(diasRacha===0){document.getElementById('fire-icon').classList.add('inactive');} renderCalendar(); }

    // ... (Tu c√≥digo de calendario y pesta√±as se mantiene igual) ...
    let currentMonthIndex = 0; 
    const monthNames = ["Octubre 2025", "Noviembre 2025", "Diciembre 2025"];

    window.cambiarMes = function(dir) {
        if (dir === 1) { currentMonthIndex++; if (currentMonthIndex > 2) currentMonthIndex = 2; } 
        else { currentMonthIndex--; if (currentMonthIndex < 0) currentMonthIndex = 0; }
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        document.getElementById('month-label').innerText = monthNames[currentMonthIndex];
        const prevBtn = document.getElementById('prev-btn');
        if (currentMonthIndex === 0) prevBtn.classList.add('hidden'); else prevBtn.classList.remove('hidden'); prevBtn.onclick = function() { cambiarMes(-1); };
        grid.innerHTML = ''; 
        ['L','M','X','J','V','S','D'].forEach(d => grid.innerHTML += `<div class="day-label">${d}</div>`);
        let offset = 0;
        if (currentMonthIndex === 0) offset = 2; // Oct empieza en Mi√©rcoles
        if (currentMonthIndex === 1) offset = 4; // Nov empieza en S√°bado
        if (currentMonthIndex === 2) offset = 6; // Dic empieza en Lunes
        for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;
        for(let i=1; i<=30; i++) {
            let className = "day-cell";
            if (currentMonthIndex === 0) {
                if (diasRacha > 0) {
                    if (i < 10) className += " completed";
                    else if (i === 10) className += " today";
                    else className += " future";
                } else {
                    if (i === 10) className += " today";
                    else className += " future";
                }
            } else { className += " future"; }
            grid.innerHTML += `<div class="${className}">${i}</div>`;
        }
    }

    // --- NAV ---
    window.openTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName == 'diario') btns[0].classList.add('active');
        if(tabName == 'racha') btns[1].classList.add('active');
        if(tabName == 'ranking') btns[2].classList.add('active');
    }

    window.toggleRanking = function(type, btn) {
        document.querySelectorAll('.rank-switch').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(type === 'amigos') {
            document.getElementById('ranking-amigos').style.display = 'block';
            document.getElementById('ranking-global').style.display = 'none';
        } else {
            document.getElementById('ranking-amigos').style.display = 'none';
            document.getElementById('ranking-global').style.display = 'block';
        }
    }

    // INICIAR TODO
    initChallenges();
    initRacha();
</script>

<script>
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-theme');
    }
</script>
</body>
</html>