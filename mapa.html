<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Econnect - Mapa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: #111; color: white; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        
        body.dark-theme {
    /* Fondo bosque muy oscuro */
    background: linear-gradient(rgba(10, 30, 15, 0.8), rgba(10, 30, 15, 0.9)), 
                        url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=2074&auto=format&fit=crop') !important;
    background-size: cover !important;
    background-position: center !important;
    background-attachment: fixed !important;
}

/* Ajuste CRUCIAL: El cristal ahora es NEGRO transl煤cido, no blanco */
body.dark-theme .glass-card,
body.dark-theme .profile-card,
body.dark-theme .settings-group,
body.dark-theme .request-capsule,
body.dark-theme .friend-item,
body.dark-theme .search-input,
body.dark-theme .challenge-card,
body.dark-theme .calendar-card,
body.dark-theme .ranking-list,
body.dark-theme .profile-rank-card,
body.dark-theme .challenge-history-item,
body.dark-theme .qr-btn,
body.dark-theme .action-btn,
body.dark-theme .gallery-item {
    background: rgba(30, 30, 30, 0.4) !important; /* Gris oscuro transparente */
    border: 1px solid rgba(255, 255, 255, 0.08); /* Borde muy sutil */
    box-shadow: 0 4px 20px rgba(0,0,0,0.4); /* Sombra m谩s fuerte */
}

/* Ajuste espec铆fico para el MEN INFERIOR en modo noche */
body.dark-theme .bottom-nav {
    background: rgba(20, 20, 20, 0.95) !important; /* Casi negro s贸lido */
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5); /* Sombra superior para separar del fondo */
}

/* Ajuste para MODALES y PANTALLAS EMERGENTES */
body.dark-theme .modal-box,
body.dark-theme .app-container.modal-view { /* Si usas contenedores tipo p谩gina */
    background: #181818 !important; /* Fondo s贸lido gris muy oscuro */
    border: 1px solid rgba(255,255,255,0.15); /* Borde m谩s visible para separar */
    box-shadow: 0 0 50px rgba(0,0,0,0.8); /* Sombra intensa alrededor */
}

/* Ajuste para textos en modo oscuro */
body.dark-theme h1, 
body.dark-theme h2, 
body.dark-theme strong,
body.dark-theme .item-text {
    color: #ffffff !important;
}
body.dark-theme p, 
body.dark-theme .section-label,
body.dark-theme .desc {
    color: #bbbbbb !important;
}
        
        
        .app-container { 
            width: 100%; max-width: 500px; height: 100vh; position: relative; 
            /* Se hace transparente para ver el mapa */
            background-color: transparent; 
            overflow: hidden; 
        }
        
        /* NUEVO CONTENEDOR DEL MAPA REAL */
        #mapid { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 0; 
        }

        .ui-layer { position: relative; z-index: 10; height: 100%; width: 100%; pointer-events: none; }
        .ui-layer > * { pointer-events: auto; }

        /* CONTROLES */
        .floating-controls { position: absolute; top: 40px; right: 20px; display: flex; flex-direction: column; gap: 15px; }
        .float-btn { width: 50px; height: 50px; background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); cursor: pointer; transition: all 0.3s; }
        .float-btn:hover { background: rgba(74, 222, 128, 0.8); transform: scale(1.1); border-color: transparent; }
        .float-btn.active-route { background: #f59e0b; border-radius: 15px; width: auto; padding: 0 15px; font-size: 14px; font-weight: 700; }

        /* SIDEBAR (LIMPIO) */
        .sidebar { position: absolute; top: 0; left: 0; height: 100%; width: 260px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.1); transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; padding-top: 60px; }
        .sidebar.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
        .sidebar-header { padding: 0 25px 30px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-title { font-size: 22px; font-weight: 700; color: white; margin: 0; }
        .sidebar-subtitle { font-size: 12px; color: #4ade80; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-item { display: flex; align-items: center; padding: 15px 25px; cursor: pointer; color: rgba(255, 255, 255, 0.7); transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: rgba(255, 255, 255, 0.05); color: white; padding-left: 30px; border-left: 3px solid #4ade80; }
        .sidebar-icon { width: 30px; font-size: 18px; text-align: center; margin-right: 10px; }
        .toggle-btn { position: absolute; top: 40px; right: -40px; width: 40px; height: 40px; background: rgba(15, 23, 42, 0.9); border-top-right-radius: 12px; border-bottom-right-radius: 12px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #4ade80; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }

        /* EKO */
        .eko-container { position: absolute; bottom: 110px; left: 20px; z-index: 20; display: flex; align-items: flex-end; gap: 5px; }
        .eko-avatar { width: 85px; height: auto; cursor: pointer; transition: transform 0.2s; display: flex; justify-content: center; align-items: flex-end; }
        .eko-avatar img { width: 100%; height: auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
        .eko-avatar:hover { transform: scale(1.1) rotate(-5deg); }
        .eko-bubble { background: white; color: #333; padding: 10px 15px; border-radius: 15px; border-bottom-left-radius: 0; font-size: 12px; font-weight: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-width: 180px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin-bottom: 30px; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* MEN INFERIOR (NUEVO ORDEN) */
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); text-decoration: none; cursor: pointer; font-size: 10px; transition: all 0.3s; position: relative; }
        .nav-item:hover i { transform: translateY(-3px); color: white; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: transform 0.3s; }
        .nav-item.active { color: #4ade80; font-weight: 600; }
        .nav-item.active i { transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -8px; width: 5px; height: 5px; background-color: #4ade80; border-radius: 50%; box-shadow: 0 0 10px #4ade80; }

    </style>
</head>
<body>

<div class="app-container">
    <div id="mapid"></div> 

    <div class="ui-layer">
        
        <div class="sidebar" id="sidebar">
            <div class="toggle-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars" id="toggle-icon"></i></div>
            <div class="sidebar-header">
                <h2 class="sidebar-title">Men煤</h2>
                <span class="sidebar-subtitle">Opciones Econnect</span>
            </div>
            <div class="sidebar-item" onclick="location.href='perfil_ajustes.html';"><i class="fa-solid fa-user sidebar-icon"></i> <span class="sidebar-text">Mi Perfil</span></div>
            <div class="sidebar-item" onclick="location.href='rutas.html';"><i class="fa-solid fa-signs-post sidebar-icon" style="color: #4ade80;"></i> <span class="sidebar-text">Ver Rutas</span></div>
            <div class="sidebar-item" onclick="location.href='voluntariado.html';"><i class="fa-solid fa-hand-holding-heart sidebar-icon" style="color: #fbbf24;"></i> <span class="sidebar-text">Voluntariado</span></div>
            <div class="sidebar-item" onclick="location.href='informacion.html';"><i class="fa-solid fa-circle-info sidebar-icon" style="color: #9ca3af;"></i> <span class="sidebar-text">Informaci贸n</span></div>
            <div class="sidebar-item" onclick="location.href='chatbot.html';"><i class="fa-solid fa-robot sidebar-icon" style="color: #a78bfa;"></i> <span class="sidebar-text">Chatbot Eko</span></div>
        </div>

        <div class="floating-controls">
            <div class="float-btn" onclick="centerMap()"><i class="fa-solid fa-location-crosshairs"></i></div>
            <div class="float-btn"><i class="fa-solid fa-layer-group"></i></div>
            <div class="float-btn active-route"><i class="fa-solid fa-route" style="margin-right:5px;"></i> CV-828</div>
        </div>

        <div class="eko-container">
            <div class="eko-avatar" onclick="location.href='chatbot.html'"><img src="eko.png" alt="Eko"></div>
            <div class="eko-bubble">隆Hola! Soy Eko. 驴Exploramos hoy? </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="location.href='mapa.html'"><i class="fa-solid fa-map-location-dot"></i><span>Mapa</span></div>
            <div class="nav-item" onclick="location.href='retos.html'"><i class="fa-solid fa-trophy"></i><span>Retos</span></div>
            <div class="nav-item" onclick="location.href='home.html'"><i class="fa-solid fa-users-line"></i><span>Social</span></div>
            <div class="nav-item" onclick="location.href='amigos.html'"><i class="fa-solid fa-user-group"></i><span>Amigos</span></div>
            <div class="nav-item" onclick="location.href='perfil.html'"><i class="fa-solid fa-user"></i><span>Perfil</span></div>
        </nav>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    let mymap; // Variable global para el mapa
    const sanVicenteCoords = [38.4000, -0.5233]; // Coordenadas de San Vicente del Raspeig



        // 1. INICIALIZACIN DEL MAPA
        mymap = L.map('mapid').setView(sanVicenteCoords, 14); // Centrado en San Vicente, Zoom 14

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(mymap);

        // 2. SIMULACIN DE DATOS LOCALES EN SAN VICENTE
        // Punto Limpio
        L.marker([38.4035, -0.5300]).addTo(mymap)
            .bindPopup("<b>Punto Limpio</b><br>Reciclaje de residuos especiales.");
            
        // Inicio de Ruta Ecol贸gica
        // Usamos un 铆cono personalizado de Font Awesome para las rutas
        const routeIcon = L.divIcon({
            className: 'route-icon', 
            html: '<i class="fa-solid fa-signs-post" style="color:#4ade80; font-size:24px; background:rgba(255,255,255,0.8); border-radius:50%; padding: 5px;"></i>', 
            iconSize: [34, 34]
        });
        L.marker([38.3970, -0.5200], {icon: routeIcon}).addTo(mymap)
            .bindPopup("<b>Ruta Ecol贸gica:</b><br>Inicio del camino verde CV-828.");


        // 3. L贸gica de re-centrado (Bot贸n de localizaci贸n)
        window.centerMap = function() {
            // Recentra el mapa en San Vicente
            mymap.setView(sanVicenteCoords, 14); 
            alert('Mapa recentrado en San Vicente del Raspeig.');
        }
        
    // L贸gica de Firebase y Auth (sin cambios)
    const firebaseConfig = { apiKey: "AIzaSyA5lPDFaH8W-miDJHB3sDKdD5fiJt8d9-8", authDomain: "ecconect-ae607.firebaseapp.com", projectId: "ecconect-ae607", storageBucket: "ecconect-ae607.firebasestorage.app", messagingSenderId: "241708782882", appId: "1:241708782882:web:514d895119f9f7c3fa817b", measurementId: "G-KJ3FLCHZCG" };
    const app = initializeApp(firebaseConfig); 
    const auth = getAuth(app);
    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "index.html"; });

    // L贸gica de Sidebar (sin cambios)
    window.toggleSidebar = function() { 
        const sidebar = document.getElementById('sidebar'); 
        const icon = document.getElementById('toggle-icon'); 
        sidebar.classList.toggle('open'); 
        if (sidebar.classList.contains('open')) { 
            icon.classList.remove('fa-bars'); 
            icon.classList.add('fa-xmark'); 
        } else { 
            icon.classList.remove('fa-xmark'); 
            icon.classList.add('fa-bars'); 
        } 
    }
</script>
<script>
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-theme');
    }
</script>
</body>
</html>